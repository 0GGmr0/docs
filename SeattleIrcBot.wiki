= seattlebot: irc bot in the #seattle channel =

seattlebot is an instance of the supybot running on seattle.cs which logs the freenode #seattle channel and provides information from Trac when tickets or changesets are mentioned.

seattlebot is unrelated to the irc messages that will get posted by MonitorProcessService in the event of a service failure.

== Logging ==

Currently seattlebot is configured to log to /home/seattlebot/logs/ChannelLogger/freenode/#seattle/

The logs can be viewed through the website here: https://seattle.cs.washington.edu/irclogs/

== Trac info in IRC ==

When a user in #seattle mentions ticket numbers or changeset numbers, seattlebot tries to grab the relevant page from Trac and display info about what was mentioned. For example, including the following in a message in #seattle should cause seattlebot to speak up:

!#100 [[BR]]
ticket 100 [[BR]]
!ticket:100 [[BR]]

!r200 [[BR]]
changeset 200 [[BR]]
!changeset:200 [[BR]]

!wiki:WikiStart

See the regex's used in !SupyTrac/plugins.py for more specifics. Notably, single-digit tickets as well as single- and double-digit changesets are currently ignored.

== Installation Instructions ==

A user account on seattle.cs was created which has supybot installed from the Ubuntu repositories. Installation instructions are as follow:

{{{
mkdir /home/seattlebot/plugins
touch /home/seattlebot/plugins/__init__.py
cd /home/seattlebot/plugins
svn co http://svn.aminus.net/misc/supybot/plugins/SupyTrac/
}}}

In order to work with the installed version of Trac, the following changes were made to /home/seattlebot/plugins/SupyTrac/plugins.py:

{{{
--- plugin.py   (revision 173)
+++ plugin.py   (working copy)
@@ -104,10 +104,14 @@
             site = g[0]
         ticketURL = self.private_uri(channel, '/'.join(('ticket', ticketNumber)))
         soup = self.getSoupFromTracUrl(ticketURL)
-        title = soup.findAll(attrs={'class': 'summary'})[0].string
+        # jsamuel: changed this to just get the second h2, as "summary" was changed
+        # to "summary searchable" and BeautifulSoup doesn't want to find that.
+        #title = soup.findAll(attrs={'class': 'summary'})[0].string
+        title = soup.findAll('h2')[1].string
         tag = soup.findAll(attrs={'class': 'status'})[0]
-        status = tag.findChild('strong')
-        status = status.string
+        #status = tag.findChild('strong')
+        #status = status.string
+        status = tag.string
         ticketURL = self.public_uri(channel, '/'.join(('ticket', ticketNumber)))
         irc.reply('%s - %s - %s' % (ticketURL, status, title), prefixNick=False)
     ticketSnarfer = urlSnarfer(ticketSnarfer)
@@ -124,7 +128,9 @@
             site = g[0]
         changesetURL = self.private_uri(channel, '/'.join(('changeset', revisionNumber)))
         soup = self.getSoupFromTracUrl(changesetURL)
-        p = soup.findAll('dd', attrs={'class': 'message'})[0]
+        # jsamuel
+        #p = soup.findAll('dd', attrs={'class': 'message'})[0]
+        p = soup.findAll('dd')[2]
         message_tags = p.findAll(text=lambda text: isinstance(text, NavigableString))
         message = ''.join([tag for tag in message_tags]).replace('\n', ' ')
         author = soup.findAll('dd', attrs={'class': 'author'})[0].string
}}}

All plugins besides !ChannelLog and !SupyTrac were disabled in the /home/seattlebot/seattlebot.conf. 

The following was added to /etc/rc.local to start supybot on startup:

sudo -u seattlebot supybot /home/seattlebot/seattlebot.conf >>/home/seattlebot/stdout-stderr.log 2>&1 &

To make the logs available through the website, the following was added to /etc/apache2/sites-available/default's https vhost:

{{{
    Alias /irclogs /home/seattlebot/logs/ChannelLogger/freenode/#seattle
    <Location /irclogs>
      SetHandler None
    </Location>
    <Directory "/home/seattlebot/logs/ChannelLogger/freenode/#seattle">
      Options +Indexes
      Order allow,deny
      Allow from all
    </Directory>
}}}